<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Reva Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>

    <style> 
        body { font-family: 'Inter', sans-serif; }
        /* UPDATED: Added styles for map popups */
        .leaflet-popup-content-wrapper { background-color: #f9fafb; color: #1f2937; border-radius: 0.5rem; }
        .dark .leaflet-popup-content-wrapper { background-color: #1f2937; color: #d1d5db; }
        .leaflet-popup-tip { background-color: #f9fafb; }
        .dark .leaflet-popup-tip { background-color: #1f2937; }
        .leaflet-popup-content h3 { font-weight: bold; color: #C0392B; }
        .leaflet-popup-content p { margin: 4px 0; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">
    <div class="flex">
        
        <%- include('partials/sidebar') %>

        <main class="flex-1 h-screen overflow-y-auto p-6 md:p-8">
            <header class="flex justify-between items-center mb-8">
                 <div>
                    <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Riyadh Water Consumption Dashboard</h1>
                    <p class="text-slate-500 dark:text-slate-400 mt-1">An overview of water meter data and performance.</p>
                </div>
                <div class="flex items-center gap-4">
                     <div class="relative" id="user-dropdown">
                        <button id="dropdown-toggle" class="flex items-center gap-2 p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                            <span class="font-semibold text-sm"><%= user.name %></span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="dropdown-menu" class="absolute hidden right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-lg shadow-xl z-10 border border-slate-200 dark:border-slate-700 py-1">
                            <a href="/logout" class="flex items-center gap-3 px-4 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700">
                                <i class="fa-solid fa-arrow-right-from-bracket"></i>
                                <span>Logout</span>
                            </a>
                        </div>
                    </div>
                    <button id="theme-toggle" class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </header>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md flex items-center gap-4">
                    <div class="bg-sky-100 dark:bg-sky-900 p-3 rounded-full"><i class="fa-solid fa-gauge-high fa-2x text-sky-500"></i></div>
                    <div>
                        <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Total Meters</p>
                        <p class="text-2xl font-bold text-slate-900 dark:text-white"><%= kpis.totalMeters %></p>
                    </div>
                </div>
                 <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md flex items-center gap-4">
                    <div class="bg-green-100 dark:bg-green-900 p-3 rounded-full"><i class="fa-solid fa-power-off fa-2x text-green-500"></i></div>
                    <div>
                        <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Active Meters</p>
                        <p class="text-2xl font-bold text-slate-900 dark:text-white"><%= kpis.activeMeters %></p>
                    </div>
                </div>
                 <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md flex items-center gap-4">
                    <div class="bg-indigo-100 dark:bg-indigo-900 p-3 rounded-full"><i class="fa-solid fa-droplet fa-2x text-indigo-500"></i></div>
                    <div>
                        <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Total Consumption</p>
                        <p class="text-2xl font-bold text-slate-900 dark:text-white"><%= (kpis.totalConsumption / 1000).toFixed(1) %>K gal</p>
                    </div>
                </div>
                 <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md flex items-center gap-4">
                    <div class="bg-amber-100 dark:bg-amber-900 p-3 rounded-full"><i class="fa-solid fa-money-bill-wave fa-2x text-amber-500"></i></div>
                    <div>
                        <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Total Billed</p>
                        <p class="text-2xl font-bold text-slate-900 dark:text-white">SAR <%= kpis.totalBilled.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) %></p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <h3 class="font-semibold text-slate-900 dark:text-white mb-4">Meter Locations in Riyadh</h3>
                    <div id="dashboard-map" style="height: 400px;" class="rounded-lg"></div>
                </div>
                <div class="flex flex-col gap-6">
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                        <h3 class="font-semibold text-slate-900 dark:text-white mb-4">Consumption by Building Type</h3>
                        <div id="building-type-chart" style="height: 180px;"></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                        <h3 class="font-semibold text-slate-900 dark:text-white mb-4">Meter Status Overview</h3>
                        <div id="status-chart" style="height: 180px;"></div>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md mb-8">
                <h3 class="font-semibold text-slate-900 dark:text-white mb-4">Total Consumption per Meter (gal)</h3>
                <div id="consumption-per-meter-chart" style="width: 100%; height:350px;"></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <h3 class="font-semibold text-slate-900 dark:text-white mb-4">Recent Payments</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                                <% recentPayments.forEach(payment => { %>
                                    <tr>
                                        <td class="py-3 whitespace-nowrap text-sm text-slate-600 dark:text-slate-300">
                                            <p class="font-medium text-slate-800 dark:text-slate-100"><%= payment.description %></p>
                                            <p class="text-xs">Meter: <%= payment.meterId %></p>
                                        </td>
                                        <td class="py-3 whitespace-nowrap text-sm text-right font-semibold <%= payment.type === 'Credit' ? 'text-green-500' : 'text-red-500' %>"><%= payment.amount %></td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <h3 class="font-semibold text-slate-900 dark:text-white mb-4">Meters Needing Attention</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                           <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                                <% if (attentionMeters.length > 0) { %>
                                    <% attentionMeters.forEach(meter => { %>
                                        <tr>
                                            <td class="py-3 whitespace-nowrap text-sm font-medium text-[#C0392B]"><%= meter.id %></td>
                                            <td class="py-3 whitespace-nowrap text-sm text-slate-600 dark:text-slate-300"><%= meter.location %></td>
                                            <td class="py-3 whitespace-nowrap text-sm text-slate-600 dark:text-slate-300 text-right"><%= meter.lastReading %></td>
                                        </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr><td class="py-3 text-sm text-slate-500 dark:text-slate-400">No meters currently need attention.</td></tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>
    <%- include('partials/scripts') %>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA FROM SERVER ---
            const mapData = <%- JSON.stringify(mapData) %>;
            const buildingTypeData = <%- JSON.stringify(charts.buildingType) %>;
            const statusData = <%- JSON.stringify(charts.status) %>;
            const consumptionData = <%- JSON.stringify(charts.consumptionPerMeter) %>;
            
            // --- MAP ---
            const map = L.map('dashboard-map', { attributionControl: false }).setView([24.7136, 46.6753], 11);
            let currentTileLayer = null;

            const lightTiles = 'https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png';
            const darkTiles = 'https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png';
            const stadiaAttribution = '&copy; Stadia Maps, &copy; OpenMapTiles &copy; OpenStreetMap';

            const updateMapTheme = () => {
                const isDark = document.documentElement.classList.contains('dark');
                const tileUrl = isDark ? darkTiles : lightTiles;

                if (currentTileLayer) {
                    map.removeLayer(currentTileLayer);
                }
                currentTileLayer = L.tileLayer(tileUrl, { attribution: stadiaAttribution }).addTo(map);
            };

            const iconMappings = {
                'Residential Building': { icon: 'home', color: 'blue' },
                'Commercial Building': { icon: 'building', color: 'orange' },
                'Government Building': { icon: 'landmark', color: 'purple' },
                'default': { icon: 'question-circle', color: 'gray' }
            };

            // NEW: Helper function to generate status badges, copied from usage-details
            const getStatusBadgeHTML = (status) => {
                let statusClass = 'bg-yellow-100 text-yellow-800';
                if (status === 'Active') statusClass = 'bg-green-100 text-green-800';
                if (status === 'Inactive') statusClass = 'bg-slate-200 text-slate-800';
                return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${status}</span>`;
            };
            
            mapData.forEach(meter => {
                const iconDetails = iconMappings[meter.buildingType] || iconMappings.default;
                const markerIcon = L.AwesomeMarkers.icon({ icon: iconDetails.icon, prefix: 'fa', markerColor: iconDetails.color });
                
                // UPDATED: Create detailed popup content
                const popupContent = `
                    <h3>${meter.id}</h3>
                    <p><strong>Building:</strong> ${meter.buildingType}</p>
                    <p><strong>Status:</strong> ${getStatusBadgeHTML(meter.status)}</p>
                    <p><strong>Location:</strong> ${meter.location}</p>
                    <hr style="margin: 4px 0;">
                    <p><strong>Last Reading:</strong> ${meter.lastReading}</p>
                    <p><strong>Total Readings:</strong> ${meter.totalReadings}</p>
                    <p><strong>Amount:</strong> ${meter.amount}</p>
                `;
                
                L.marker([meter.lat, meter.lng], { icon: markerIcon }).addTo(map).bindPopup(popupContent);
            });
            
            // --- CHARTS ---
            const buildingTypeChartEl = document.getElementById('building-type-chart');
            const statusChartEl = document.getElementById('status-chart');
            const consumptionChartEl = document.getElementById('consumption-per-meter-chart');

            const lightThemeColors = ['#C0392B', '#2980B9', '#27AE60', '#F1C40F', '#8E44AD'];
            const darkThemeColors = ['#E74C3C', '#3498DB', '#2ECC71', '#F39C12', '#9B59B6'];

            const getThemeOptions = () => {
                const isDark = document.documentElement.classList.contains('dark');
                return {
                    backgroundColor: 'transparent',
                    textStyle: { color: isDark ? '#e2e8f0' : '#334155' },
                    legend: { textStyle: { color: isDark ? '#94a3b8' : '#64748b' } },
                    xAxis: { axisLine: { lineStyle: { color: isDark ? '#475569' : '#d1d5db' } } },
                    yAxis: { axisLine: { lineStyle: { color: isDark ? '#475569' : '#d1d5db' } } },
                    color: isDark ? darkThemeColors : lightThemeColors
                };
            };
            
            let buildingTypeChart = echarts.init(buildingTypeChartEl);
            let statusChart = echarts.init(statusChartEl);
            let consumptionChart = echarts.init(consumptionChartEl);

            const buildingTypeOptions = {
                tooltip: { trigger: 'item', formatter: '{b}: {c} gal ({d}%)' },
                legend: { show: false },
                series: [{
                    name: 'Consumption', type: 'pie', radius: '80%', data: buildingTypeData, label: { fontSize: 10 },
                    emphasis: { itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' } }
                }]
            };

            const statusOptions = {
                tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                legend: { show: false },
                series: [{
                    name: 'Meter Status', type: 'pie', radius: ['50%', '80%'], avoidLabelOverlap: false,
                    label: { show: false, position: 'center' },
                    emphasis: { label: { show: true, fontSize: '18', fontWeight: 'bold' } },
                    labelLine: { show: false }, data: statusData
                }]
            };

            const consumptionOptions = {
                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: [{ type: 'category', data: consumptionData.ids, axisTick: { alignWithLabel: true } }],
                yAxis: [{ type: 'value', name: 'Gallons' }],
                series: [{ name: 'Total Consumption', type: 'bar', barWidth: '60%', data: consumptionData.values }]
            };
            
            const renderChartsAndMap = () => {
                const themeOpts = getThemeOptions();
                buildingTypeChart.setOption({ ...buildingTypeOptions, ...themeOpts });
                statusChart.setOption({ ...statusOptions, ...themeOpts });
                consumptionChart.setOption({ ...consumptionOptions, ...themeOpts });
                updateMapTheme();
            };

            renderChartsAndMap();

            const themeButton = document.getElementById('theme-toggle');
            if (themeButton) {
                themeButton.addEventListener('click', () => {
                    setTimeout(renderChartsAndMap, 50);
                });
            }

            window.addEventListener('resize', () => {
                buildingTypeChart.resize();
                statusChart.resize();
                consumptionChart.resize();
            });
        });
    </script>
</body>
</html>